# Linux 防火墙

## 概念
    Linux防火墙是由Netfilter组件提供的，NetFilter工作在内核空间，集成在Linux内核中，
    而iptables只是一个工作在用户空间的一个命令行工具，用来编写规则，写好的规则被送往netfilter，
    告诉内核如何去处理信息包

## 数据包过滤匹配流程

<img src="../images/iptables01.png">

## netfilter的5表和5链
### netfilter 提供了五种表，每种表用于处理不同类型的数据包决策：(优先级从上到下增加)
* Filter Table：最常用的表，用于决定数据包的命运，如允许或阻止数据包通过。
* NAT Table：用于网络地址转换，如源NAT（SNAT）和目标NAT（DNAT）。
* Mangle Table：用于修改数据包的服务质量（QoS）标记和其他包头信息。
* Raw Table：用于设置不需要由连接跟踪系统处理的数据包。
* Security Table：用于设置强制访问控制（MAC）安全规则，通常与 SELinux 安全策略配合使用
### 五链,每个表包含几个预定义的链(内置链)，数据包根据其流向和处理需求经过不同的链：
* INPUT：处理到达本机的数据包。
* OUTPUT：处理由本机发出的数据包。
* FORWARD：处理穿过本机（路由）的数据包。
* PREROUTING：用于在路由决策之前处理进入的数据包（主要用在 NAT 表）。
* POSTROUTING：用于在路由决策之后处理即将离开的数据包（主要用在 NAT 表）。

## iptables 查看规则
```bash
iptables -S #查看更加详细的配置信息
iptables -vnL -t filter  #默认filter
iptables -vnL  -t filter  --line-numbers #显示规则行号
```

## iptables设置规则
数据包从PREROUTING 流入，POSTROUTING 流出，中间经过链条，按照链条所属的表优先级从高到低处理
在每个表内，例如filter表，INPUT链，那么按照filter表的INPUT链上的规则从上到下匹配处理，符合匹配，
就处理，不匹配就继续往下匹配规则，直到规则走完

### 基本匹配(不需要使用额外模块)
```bash
iptables   [-t table]   SUBCOMMAND   chain   [-m matchname [per-match-options]]   -j targetname [per-target-options]
            -t 哪个表   管理命令      那条链    哪个模块       具体匹配条件和选项      处理动作      
 管理命令 ：
        -N：new, 自定义一条新的规则链
        -E：重命名自定义链；引用计数不为0的自定义链不能够被重命名，也不能被删除
        -X：delete，删除自定义的空的规则链
        -P：Policy，设置默认策略；对filter表中的链而言，其默认策略有：ACCEPT：接受, DROP：丢弃
            范例：
                iptables -N test-chain  -t filter
                iptables -E test-chain  test1-chain
                iptables -X test1-chain

                #往自定义链条添加规则
                iptables -t filter  -A web -s 10.0.0.3   -j DROP 

                #在内置链条上引用自定义链
                iptables -A INPUT -j web
        
        -A：append，追加
        -I：insert, 插入，要指明插入至的规则编号，默认为第一条
        -D：delete，删除
            (1) 指明规则序号
            (2) 指明规则本身
        -R：replace，替换指定链上的指定规则编号
        -F：flush，清空指定的规则链
        -Z：zero，置零
            iptables的每条规则都有两个计数器
                (1) 匹配到的报文的个数
                (2) 匹配到的所有报文的大小之和


```



