# 网络基础

## 各种网络设备特点

```bash

hub 集线器  
    一层设备  
    所有连接的计算机在一个冲突域中

switch 交换机
    二层设备 每个口是一个冲突域
    能够阻止冲突域，不能够阻止广播域

router 路由器
    三层设备  每个口在一个网段中，一个口在一个广播域中
    能够阻止广播域

计算机网卡  工作在二层， 二层处理之后的数据会交由计算机的更高层处理

VMware 的每个网络段相当于所有计算机连接在一个hub上，所以其中任何一个计算机，都可以拿到网络中所有通信的数据包
    
```

## 以太网的MAC帧序列
<img src="../images/ethMacFrame01.png">


## VLan 帧序列 
<img src="../images/vlanFrame01.png">


## TCP包头
<img src="../images/tcppackage01.png">

```bash
port: 0-65535
0-1023：系统端口或特权端口(仅管理员可用) ，众所周知，永久的分配给固定的系统应用使用，22/tcp(ssh), 80/tcp(http), 443/tcp(https)

1024-49151：用户端口或注册端口，但要求并不严格，分配给程序注册为某应用使用，
1433/tcp(SqlServer), 1521/tcp(oracle),3306/tcp(mysql),11211/tcp/udp (memcached)

49152-65535：动态或私有端口，客户端随机使用端口，范围定
义：/proc/sys/net/ipv4/ip_local_port_range

注意：当前6000，6665-6669/tcp等端口被Google Chrome 设为默认非安全端口，尽量避免使用

#查看非特权用户可以使用的端口
cat /proc/sys/net/ipv4/ip_unprivileged_port_start 
1024


#注意:在容器中默认起始端口为0,即非特权用户也可以使用任何端口


调整客户端的动态端口范围
echo 20000 62000 > /proc/sys/net/ipv4/ip_local_port_range


```

## 三次握手

<img src="../images/handshaking01.png">


## 四次挥手

<img src="../images/handshaking04.png">

```bash
sysctl net.ipv4.tcp_fin_timeout
cat /proc/sys/net/ipv4/tcp_fin_timeout

```

## 内核TCP 参数优化

man 7 tcp

编辑文件 /etc/sysctl.conf 加入以下内容，然后执行 sysctl -p 让参数生效

```bash
net.ipv4.tcp_fin_timeout = 2
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_tw_recycle = 1
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_keepalive_time = 600
net.ipv4.ip_local_port_range = 2000 65000
net.ipv4.tcp_max_syn_backlog = 16384
net.ipv4.tcp_max_tw_buckets = 36000
net.ipv4.route.gc_timeout = 100
net.ipv4.tcp_syn_retries = 1
net.ipv4.tcp_synack_retries = 1
net.ipv4.tcp_max_orphans = 16384
net.core.somaxconn = 16384
net.core.netdev_max_backlog = 16384

net.ipv4.tcp_fin_timeout 表示套接字由本端要求关闭，这个参数决定了它保持在FIN-WAIT-2状态的时间，默认值是60秒。 该参数对应系统路径为：/proc/sys/net/ipv4/tcp_fin_timeout 60
net.ipv4.tcp_tw_reuse 表示开启重用。允许将TIME-WAIT sockets重新用于新的TCP连接，默认值为0，表示关闭。 该参数对应系统路径为：/proc/sys/net/ipv4/tcp_tw_reuse 0
net.ipv4.tcp_tw_recycle 表示开启TCP连接中TIME-WAIT sockets的快速回收。 该参数对应系统路径为：/proc/sys/net/ipv4/tcp_tw_recycle，默认为0，表示关闭。 提示：reuse和recycle这两个参数是为防止生产环境下服务器time_wait网络状态数量过多设置的。
net.ipv4.tcp_syncookies 表示开启SYN Cookies功能。当出现SYN等待队列溢出时，启用Cookies来处理，可防范少量SYN攻击，这个参数也可以不添加。 该参数对应系统路径为：/proc/sys/net/ipv4/tcp_syncookies,默认值为1
net.ipv4.tcp_keepalive_time 表示当keepalive启用时，TCP发送keepalive消息的频度。默认是2小时，建议改为10分钟。 该参数对应系统路径为：/proc/sys/net/ipv4/tcp_keepalive_time,默认为
7200秒。


```


## 常用命令

```bash
探测网卡工作情况:(网卡带宽，网卡的工作模式和网卡是否在启用)
    yum install net-tools

    mii-tool  eth0
    mii-tool -v eth0
    ethtool  eth0
    ethtool -i eth0
    ip -a


nc 工具
yum install nc

nc -l 22  #监听tcp22端口
nc -l 22 -u  #监听udp22端口


nc 10.0.0.3 22 #连接22 端口

ss -ntlup
    -n 数字显示端口
    -t tcp
    -u udp
    -l 显示在监听的端口 
    -p 显示进程

查看端口占用程序
ss -ntlp 
lsof -i :22


判断端口是否打开
< /dev/tcp/127.0.0.1/80
echo $?


```

