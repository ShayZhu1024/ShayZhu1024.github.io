# 进程和计划任务

## 1. 进程相关概念

```bash
进程是资源分配的单位，线程是cpu调度的最小单位
UID，GID，SELINUX语境决定了对文件系统的存取和访问权限
init 是第一个进程，centos7 之后改为systemd
进程都是由父进程创建的，fork() 父子关系，cow，copy on write

```

## 2.内存常见问题

```bash
1. Memory Leak  内存泄漏，指的是分配的内存没有得到回收，即没有使用，也没有得到回收，相当于一直占用
2. Memory Overflow 内存溢出， 往申请的空间里写超过空间大小的数据，比如10M 写10M
3.OOM out of memory 内存不足，把内存用完了，此时，系统会随机挑选进程杀掉，况在java程序中比较常见
Jul 10 10:20:30 kernel: Out of memory: Kill process 9527 (java) score 88 or sacrifice child
当JVM因为没有足够的内存来为对象分配空间并且垃圾回收器也已经没有空间可回收时，就会抛出这个error，因为这个问题已经严重到不足以被应用处理

原因：
    给应用分配内存太少：比如虚拟机本身可使用的内存（一般通过启动时的VM参数指定）太少。
    应用用的太多，并且用完没释放，浪费了。此时就会造成内存泄露或者内存溢出。

使用的解决办法：
    限制java进程的max heap，并且降低java程序的worker数量，从而降低内存使用
    给系统增加swap空间
    设置内核参数（不推荐），不允许内存申请过量：
    /proc/sys/vm/overcommit_memory  #过度提交内容，过度申请内存
    0   这是缺省值，它允许overcommit，但过于明目张胆的overcommit会被拒绝，比如malloc一次性申请的内存大小就超过了系统总内存。它认为不合理就会拒绝overcommit
    1  完全允许
    2  完全禁止

```

## 3.进程状态
<img src="../images/procstatus01.png">

## 4.进程更多的状态

* 运行态：running
* 就绪态：ready
* 睡眠态：分为两种，可中断：interruptable，不可中断：uninterruptable
* 停止态：stopped，暂停于内存，但不会被调度，除非手动启动
* 僵死态：zombie，僵尸态，结束进程，父进程结束前，子进程不关闭，杀死父进程可以关闭僵死态的子进程

### 孤儿进程
```bash
如果在子进程在退出前，父进程先退出,这时子进程将成为孤儿进程，因为它的父进程已经死了。孤儿进程会被
PID=1的systemd进程收养，成为systemd的子进程.注意，孤儿进程还会继续运行，而不会随父进程退出而终止，只不过其父进程发生了改变。
```

### ps命令stat字段值
```bash
  D    uninterruptible sleep (usually IO)       #不可中断睡眠
  I    Idle kernel thread                       #空闲的内核进程
  R    running or runnable (on run queue)       #在运行或可运行
  S    interruptible sleep (waiting for an event to complete) #可终端睡眠
  T    stopped by job control signal           #被任务控制信号停止掉了
  t    stopped by debugger during the tracing  # 被debugger停止掉
  Z    defunct ("zombie") process, terminated but not reaped by its parent #僵尸进程

对于BSD格式风格，在这些状态值之上，还会有额外的修饰
 <    high-priority (not nice to other users)
 N    low-priority (nice to other users)
 L    has pages locked into memory (for real-time and custom IO) #有一部分内容被锁定到内存中，不能放到swap中
 s    is a session leader
 l    is multi-threaded (using CLONE_THREAD, like NPTL pthreads do)
 +    is in the foreground process group 


```

## IPC进程间通信
```bash
pipe
socket
Memory-maped file   文件映射,将文件中的一段数据映射到物理内存，多个进程共享这片内存
shm shared memory 共享内存
signal 信号
Lock   对资源上锁，如果资源已被某进程锁住，则其它进程想修改甚至读取这些资源，都将被阻塞，直到锁被打开
semaphore 信号量，一种计数器, 
```
不同主机 socket=ip+端口号

## 进程优先级
<img src="../images/procpriority01.png">