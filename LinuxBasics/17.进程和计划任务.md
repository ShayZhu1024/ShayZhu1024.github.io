# 进程和计划任务

## 1. 进程相关概念

```bash
进程是资源分配的单位，线程是cpu调度的最小单位
UID，GID，SELINUX语境决定了对文件系统的存取和访问权限
init 是第一个进程，centos7 之后改为systemd
进程都是由父进程创建的，fork() 父子关系，cow，copy on write

```

## 2.内存常见问题

```bash
1. Memory Leak  内存泄漏，指的是分配的内存没有得到回收，即没有使用，也没有得到回收，相当于一直占用
2. Memory Overflow 内存溢出， 往申请的空间里写超过空间大小的数据，比如10M 写10M
3.OOM out of memory 内存不足，把内存用完了，此时，系统会随机挑选进程杀掉，况在java程序中比较常见
Jul 10 10:20:30 kernel: Out of memory: Kill process 9527 (java) score 88 or sacrifice child
当JVM因为没有足够的内存来为对象分配空间并且垃圾回收器也已经没有空间可回收时，就会抛出这个error，因为这个问题已经严重到不足以被应用处理

原因：
    给应用分配内存太少：比如虚拟机本身可使用的内存（一般通过启动时的VM参数指定）太少。
    应用用的太多，并且用完没释放，浪费了。此时就会造成内存泄露或者内存溢出。

使用的解决办法：
    限制java进程的max heap，并且降低java程序的worker数量，从而降低内存使用
    给系统增加swap空间
    设置内核参数（不推荐），不允许内存申请过量：
    /proc/sys/vm/overcommit_memory  #过度提交内容，过度申请内存
    0   这是缺省值，它允许overcommit，但过于明目张胆的overcommit会被拒绝，比如malloc一次性申请的内存大小就超过了系统总内存。它认为不合理就会拒绝overcommit
    1  完全允许
    2  完全禁止

```

## 3.进程状态
<img src="../images/procstatus01.png">

## 4.进程更多的状态

* 运行态：running
* 就绪态：ready
* 睡眠态：分为两种，可中断：interruptable，不可中断：uninterruptable
* 停止态：stopped，暂停于内存，但不会被调度，除非手动启动
* 僵死态：zombie，僵尸态，结束进程，父进程结束前，子进程不关闭，杀死父进程可以关闭僵死态的子进程

### 孤儿进程
```bash
如果在子进程在退出前，父进程先退出,这时子进程将成为孤儿进程，因为它的父进程已经死了。孤儿进程会被
PID=1的systemd进程收养，成为systemd的子进程.注意，孤儿进程还会继续运行，而不会随父进程退出而终止，只不过其父进程发生了改变。
```

### ps命令stat字段值
```bash
  D    uninterruptible sleep (usually IO)       #不可中断睡眠
  I    Idle kernel thread                       #空闲的内核进程
  R    running or runnable (on run queue)       #在运行或可运行
  S    interruptible sleep (waiting for an event to complete) #可终端睡眠
  T    stopped by job control signal           #被任务控制信号停止掉了
  t    stopped by debugger during the tracing  # 被debugger停止掉
  Z    defunct ("zombie") process, terminated but not reaped by its parent #僵尸进程

对于BSD格式风格，在这些状态值之上，还会有额外的修饰
 <    high-priority (not nice to other users)
 N    low-priority (nice to other users)
 L    has pages locked into memory (for real-time and custom IO) #有一部分内容被锁定到内存中，不能放到swap中
 s    is a session leader
 l    is multi-threaded (using CLONE_THREAD, like NPTL pthreads do)
 +    is in the foreground process group 


```

## IPC进程间通信
```bash
pipe
socket
Memory-maped file   文件映射,将文件中的一段数据映射到物理内存，多个进程共享这片内存
shm shared memory 共享内存
signal 信号
Lock   对资源上锁，如果资源已被某进程锁住，则其它进程想修改甚至读取这些资源，都将被阻塞，直到锁被打开
semaphore 信号量，一种计数器, 
```
不同主机 socket=ip+端口号

## 进程优先级
<img src="../images/procpriority01.png">

```bash
系统优先级：0-139, 数字越小，优先级越高,各有140个运行队列和过期队列
实时优先级: 99-0   值最大优先级最高
nice值：-20到19，对应系统优先级100-139或
```

## 进程分类
* 守护进程: daemon,在系统引导过程中启动的进程，和终端无关进程
* 前台进程：跟终端相关，通过终端启动的进程
    * 守护和前台进程可以相互转化
* CPU-Bound：CPU 密集型，非交互
* IO-Bound：IO 密集型，交互

## 进程管理和性能相关工具
[www.brendangregg.com](https://www.brendangregg.com/linuxperf.html)
<img src="../images/procmanager01.png">

### pstree
pstree 可以用来显示进程的父子关系，以树形结构显示
```bash
pstree   [OPTION] [ PID | USER ]
-p 显示PID
-T 不显示线程thread,默认显示线程
-u 显示用户切换
-H pid 高亮显示指定进程及其前辈进程
```

#### ps 
ps 即 process state，进程当前状态的快照，默认显示当前终端中的进程，Linux系统各进程的相关信息均保存在/proc/PID目录下的各文件中
```bash
a　选项包括所有终端中的进程
x　选项包括不链接终端的进程
u　选项显示进程所有者的信息
f　选项显示进程树,相当于 --forest
k|--sort 属性 对属性排序,属性前加 - 表示倒序
o　属性… 选项显示定制的信息 pid、cmd、%cpu、%mem
-C cmdlist 指定命令，多个命令用，分隔
-L 显示线程
-e 显示所有进程，相当于-A
-f 显示完整格式程序信息
-F 显示更完整格式的进程信息
-H 以进程层级格式显示进程相关信息
-u userlist 指定有效的用户ID或名称
-U userlist 指定真正的用户ID或名称
-g gid或groupname 指定有效的gid或组名称
-G gid或groupname 指定真正的gid或组名称
-p pid 显示指pid的进程
--ppid pid 显示属于pid的子进程
-t ttylist 指定tty,相当于 t
-M 显示SELinux信息，相当于Z

具体信息 man ps 
查看列  man ps, search standard format
```

### 实现进程和CPU的绑定
```bash
taskset

```

### prtstat
可以显示进程信息,来自于psmisc包
```bash
prtstat [options] PID ...
显示信息来自 /proc/进程ID/satus  文件
```    

### 设置和调整进程优先级
```bash
静态优先级：100-139
进程默认启动时的nice值为0，优先级为120
只有根用户才能降低nice值（提高优先性）

nice [OPTION] [COMMAND [ARG]...]

```

### 搜索进程
```bash
ps 选项　| grep 'pattern' 灵活

pgrep 按预定义的模式
    -u uid: effective user，生效者
    -U uid: real user，真正发起运行命令者
    -t terminal: 与指定终端相关的进程
    -l: 显示进程名
    -a: 显示完整格式的进程名
    -P pid: 显示指定进程的子进程

/sbin/pidof 按确切的程序名称查看pid
```

### uptime 负载查询
```bash
```
