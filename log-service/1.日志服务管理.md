# 日志服务管理

rsyslog是CentOS 6 以后版本的系统日志管理服务

https://www.rsyslog.com/

**rsyslog 特性**
* 多线程
* UDP, TCP, SSL, TLS, RELP
* MySQL, PGSQL, Oracle实现日志存储
* 强大的过滤器，可实现过滤记录日志信息中任意部分
* 自定义输出格式
* 适用于企业级中继链

##  Rsyslog 管理

### 系统日志术语

###### facility：设施，从功能或程序上对日志进行归类
```bash
#内置分类
auth, authpriv, cron, daemon,ftp,kern, lpr, mail, news, security(auth), 
user(default), uucp, syslog
#自定义的分类
local0-local7
```
###### Priority 优先级别，从低到高排序
```bash
debug,info, notice, warn(warning), err(error), crit(critical), alert, 
emerg(panic)

参看帮助： man 3 syslog，man logger

```

###  rsyslog 相关文件

* 程序包：rsyslog
* 主程序：/usr/sbin/rsyslogd
* Ubuntu: /usr/lib/systemd/system/rsyslog.service
* CentOS 6：/etc/rc.d/init.d/rsyslog {start|stop|restart|status}
* CentOS 7,8：/usr/lib/systemd/system/rsyslog.service
* 配置文件：/etc/rsyslog.conf，/etc/rsyslog.d/*.conf
* 库文件： /lib64/rsyslog/*.so 

###  rsyslog配置文件
/etc/rsyslog.conf 配置文件格式：由三部分组成

* MODULES：相关模块配置
* GLOBAL DIRECTIVES：全局配置
* RULES：日志记录相关的规则配置

RULES配置格式：

```bash
facility.priority; facility.priority… target
```

facility格式：

```bash
*     #所有的facility  
facility1,facility2,facility3,...         #指定的facility列表

```

priority格式：

```bash
*: 所有级别
none：没有级别，即不记录
PRIORITY：指定级别（含）以上的所有级别
=PRIORITY：仅记录指定级别的日志信息

```

target格式：

```bash
文件路径：通常在/var/log/，文件路径前的-表示异步写入
用户：将日志事件通知给指定的用户，* 表示登录的所有用户
日志服务器：@host，把日志送往至指定的远程UDP日志服务器 @@host 将日志发送到远程TCP日志服务器
管道： | COMMAND，转发给其它命令处理

```


###### 通常的日志文件的格式：
```bash
事件产生的日期时间 主机 进程(pid)：事件内容
```


### 启用高精度时间
```bash
ubuntu，注释掉以下行
vim /etc/rsyslog.conf
# To enable high precision timestamps, comment out the following line.
$ActionFileDefaultTemplate RSYSLOG_TraditionalFileFormat

红帽，注释掉以下行
vim /etc/rsyslog.conf
# Use default timestamp format
module(load="builtin:omfile" Template="RSYSLOG_TraditionalFileFormat")

然后重启 systemctl restart rsyslog.service
```

### 自定义某些服务的日志输入位置
```bash
首先，这些服务，默认日志输出管理使用的是rsyslog，他们的日志是交由rsyslog管理的才行，否则，可能需要其他方法，才能将日志交由rsyslog管理

比如： sshd 日志服务是交由rsyslog 管理的
只需要到sshd 配置文件， 将log 位置修改为向那个设施写入
然后在 rsyslog 配置文件中，指明 这个设施 是针对那个日志文件
然后重启 rsyslog， sshd 就可以指定sshd日志写入那个日志文件中
```


### 启用rsyslog的网络日志功能
rsyslog 是可以把本机日志，输出到一个目标机器上， 这个目标机器上的rsyslog会接受这些日志，并存储

```bash
启用接受网络日志
ubuntu22，rocky8,将指定的配置文件注释打开，可以启用udp或者tcp

 # provides UDP syslog reception
 #module(load="imudp")
 #input(type="imudp" port="514")
   
 # provides TCP syslog reception
 #module(load="imtcp")
 #input(type="imtcp" port="514")

centos6 或者7 配置文件不一样，详情见对应的配置文件，按照配置文件说明打开对应注释

客户端，发送日志
#在客户端指定将日志发送到远程的TCP、UDP的日志服务器
*.info;mail.none;authpriv.none;cron.none               @@10.0.0.18:514  #TCP
*.info;mail.none;authpriv.none;cron.none               @10.0.0.18:514   #UDP


服务端接收到日志，默认红帽会存储在 /var/log/messages
ubuntu 会存储在 /var/log/syslog


当然，也可以在服务端指定，这些远程过来的日志存储在什么位置
module(load="imtcp")  # 加载 TCP 模块
input(type="imtcp" port="514")  # 监听 514 端口

template(name="HostSpecificLog" type="string"  string="/var/log/%HOSTNAME%/%PROGRAMNAME%.log")

if $fromhost-ip != '127.0.0.1' then action(type="omfile"  dynaFile="HostSpecificLog")
```

### 常见日志文件

* /var/log/secure，/var/log/auth.log：系统安全日志，文本格式，应周期性分析
* /var/log/btmp：当前系统上，用户的失败尝试登录相关的日志信息，二进制格式，lastb命令进行查看
* /var/log/wtmp：当前系统上，用户正常登录系统的相关日志信息，二进制格式，last命令可以查看
  * #显示系统关机项和运行级别更改
  * last -x, --system    
* /var/log/lastlog:每一个用户最近一次的登录信息，二进制格式，lastlog命令可以查看
* /var/log/dmesg：CentOS7 之前版本系统引导过程中的日志信息，文本格式，开机后的硬件变化将不再记录，也可以通过专用命令dmesg查看，可持续记录硬件变化的情况
* /var/log/boot.log 系统服务启动的相关信息，文本格式，Ubuntu无此文件
* /var/log/messages(红帽系统)，/var/log/syslog (Ubuntu) ：系统中大部分的信息
* /var/log/anaconda : anaconda的日志，Ubuntu无此文件

