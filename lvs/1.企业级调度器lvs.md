# 企业级调度器lvs 



## 什么是集群以及集群的分类

Cluster：集群,为解决某个特定问题将多台计算机组合起来形成的单个系统


#### Cluster 分为三种类型：

* LB：Load Balancing，负载均衡，多个主机组成，每个主机只承担一部分访问请求
* HA：High Availiablity，高可用，避免SPOF（single Point Of failure）
  * MTBF:Mean Time Between Failure 平均无故障时间，正常时间
  * MTTR:Mean Time To Restoration（ repair）平均恢复前时间，故障时间
  * A = MTBF /（MTBF+MTTR） (0,1)：99%,99.5%,99.9%,99.99%,99.999%
  * 停机时间又分为两种，一种是计划内停机时间，一种是计划外停机时间

#### [High-performance computing](https://www.top500.org/)



## 分布式和集群的区别


#### 集群
同一个业务系统部署在多台服务器上。集群中每一台服务器实现的功能没有差别，数据和代码都是一样的

#### 分布式

一个业务被拆成多个子业务，或者本身就是不同的业务，部署在多台服务器上。分布式中，每
一台服务器实现的功能是有差别的，数据和代码也是不一样的，分布式每台服务器功能加起来，才是完
整的业务


分布式是以缩短单个任务的执行时间来提升效率的，而集群则是通过提高单位时间内执行的任务数来提
升效率


## LVS

LVS：Linux Virtual Server，负载调度器，内核集成， 阿里的四层SLB(Server Load Balance)是基于LVS+keepalived实现，
LVS 是全球最流行的四层负载均衡开源软件，可以实现LINUX平台下的负载均衡 

[LSV官网](http://www.linuxvirtualserver.org/)



### LVS 工作原理以及查看内核是否支持LVS

VS根据请求报文的目标IP和目标协议及端口将其调度转发至某RS，根据调度算法来挑选RS。LVS是内核
级功能，工作在INPUT链的位置，将发往INPUT的流量进行“处理”


```bash
#查看内核编译配置选项是否支持lvs
egrep -i  ipvs  /boot/config-`uname -r`

#直接查看lvs模块
modinfo ip_vs
```


###  LVS 集群类型中的术语

* VS：Virtual Server，Director Server(DS), Dispatcher(调度器)，Load Balancer
* RS：Real Server(lvs), upstream server(nginx), backend server(haproxy)
* CIP：Client IP
* VIP：Virtual server IP VS外网的IP
* DIP：Director IP VS内网的IP
* RIP：Real server IP 
* 访问流程：CIP <--> VIP == DIP <--> RIP



### LVS 相关程序和命令

#### 程序包

**ipvsadm**

* Unit File: ipvsadm.service
* 主程序：/usr/sbin/ipvsadm
* 规则保存工具：/usr/sbin/ipvsadm-save
* 规则重载工具：/usr/sbin/ipvsadm-restore
* 配置文件：/etc/sysconfig/ipvsadm-config
* ipvs调度规则文件：/etc/sysconfig/ipvsadm

#### Ubuntu系统保存规则和开机加载规则
```bash
#保存规则
    #方法1
    [root@ubuntu2204 ~]#service ipvsadm save
    * Saving IPVS configuration...           [ OK ]
    [root@ubuntu2204 ~]#cat /etc/ipvsadm.rules
    # ipvsadm.rules
    -A -t 192.168.10.100:80 -s wlc
    -a -t 192.168.10.100:80 -r 10.0.0.7:80 -g -w 1
    -a -t 192.168.10.100:80 -r 10.0.0.17:80 -g -w 1
    #方法2
    [root@ubuntu2004 ~]#ipvsadm-save -n > /etc/ipvsadm.rules



#开机自启
[root@ubuntu2004 ~]#vim /etc/default/ipvsadm
AUTO="true"
```


#### 红帽系统保存规则和开机加载规则
```bash
#保存规则
[root@rocky8 ~]#ipvsadm-save -n > /etc/sysconfig/ipvsadm


#开机自启
[root@rocky8 ~]#systemctl enable ipvsadm.service
```

#### ipvsadm 命令


###### 集群服务管理：增、删、改
```bash
ipvsadm -A|E -t|u|f service-address [-s scheduler] [-p [timeout]]  #增加修改
ipvsadm -D -t|u|f service-address  #删除
-A 添加  -E 修改 -D 删除

-t tcp  集群服务使用tcp端口,TCP协议的端口，VIP:TCP_PORT 如: -t 10.0.0.100:80
-u udp    UDP协议的端口，VIP:UDP_PORT
-f  firewall MARK，标记，一个数字

[-s scheduler]：指定集群的调度算法，默认为wlc

比如：

添加 
ipvsadm -A -t 10.0.0.100:80 -s wrr  #创建一个集群，集群对外ip和监听tcp端口是10.0.0.100 端口80  使用wrr调度算法

删除
ipvsadm -D -t 10.0.0.100:80 -s wrr

修改
ipvsadm -E -t 10.0.0.100:80 -s rr
```


###### 集群服务的RS管理：增、删、改
```bash
ipvsadm -a|e -t|u|f service-address -r server-address [-g|i|m] [-w weight]   #增加和修改
ipvsadm -D -t|u|f service-address     #删除

server-address：
     rip[:port] 如省略port，不作端口映射
选项：
lvs类型：
    -g: gateway, dr类型，默认
    -i: ipip, tun类型
    -m: masquerade, nat类型        
-w weight：权重

比如：
ipvsadm -a -t 10.0.0.100:80 -r 10.0.0.8:8080 -m -w 3

```

###### 查看
```bash
ipvsadm -L|l [options]
--numeric, -n：以数字形式输出地址和端口号
--exact：扩展信息，精确值     
--connection，-c：当前IPVS连接输出
--stats：统计信息
--rate ：输出速率信息


ipvsadm -Ln  #常用选项
```


###### 从文件加载规则和保存规则到文件
```bash
清空定义的所有内容：
ipvsadm -C

清空计数器：
ipvsadm -Z [-t|u|f service-address]

保存规则
ipvsadm-save > /PATH/TO/IPVSADM_FILE

重载规则
ipvsadm-restore < /PATH/FROM/IPVSADM_FILE

建议保存至 /etc/sysconfig/ipvsadm  #因为这个文件是默认规则保存和加载的文件
```


###  LVS 集群的工作模式 和相关配置

####  lvs-nat：修改请求报文的目标IP,多目标IP的DNAT
lvs-nat：本质是多目标IP的DNAT，通过将请求报文中的目标地址和目标端口修改为某挑出的RS的RIP和PORT实现转发
* RIP和DIP应在同一个IP网络，且应使用私网地址；RS的网关要指向DIP
* 请求报文和响应报文都必须经由Director转发，Director易于成为系统瓶颈
* 支持端口映射，可修改请求报文的目标PORT
* VS必须是Linux系统，RS可以是任意OS系统

<img src="../images/lvs-nat01.png">

<img src="../images/lvs-nat02.png">


#### lvs-dr：操纵封装新的MAC地址

LVS-DR：Direct Routing，直接路由，LVS默认模式,应用最广泛,通过为请求报文重新封装一个MAC首部
进行转发，源MAC是DIP所在的接口的MAC，目标MAC是某挑选出的RS的RIP所在接口的MAC地址；源IP/PORT，以及目标IP/PORT均保持不变

** DR模式的特点：**
* Director和各RS都配置有VIP
* 确保前端路由器将目标IP为VIP的请求报文发往Director
  * 在前端网关做静态绑定VIP和Director的MAC地址
  * 在RS上使用arptables工具
  * 在RS上修改内核参数以限制arp通告及应答级别
* RS的RIP可以使用私网地址，也可以是公网地址；RIP与DIP在同一IP网络；RIP的网关不能指向DIP，以确保响应报文不会经由Director
* RS和Director要在同一个物理网络
* 请求报文要经由Director，但响应报文不经由Director，而由RS直接发往Client
* 不支持端口映射（端口不能修改）
*  无需开启 ip_forward
*  RS可使用大多数OS系统





<img src="../images/lvs-dr01.png">
<img src="../images/lvs-dr02.png">


#### lvs-tun：在原请求IP报文之外新加一个IP首部
转发方式：不修改请求报文的IP首部（源IP为CIP，目标IP为VIP），而在原IP报文之外再封装一个IP首部
（源IP是DIP，目标IP是RIP），将报文发往挑选出的目标RS；RS直接响应给客户端（源IP是VIP，目标IP是CIP）

**TUN模式特点:**
* RIP和DIP可以不处于同一物理网络中，RS的网关一般不能指向DIP,且RIP可以和公网通信。也就是说集群节点可以跨互联网实现。DIP, VIP, RIP可以是公网地址
* RealServer的tun接口上需要配置VIP地址，以便接收director转发过来的数据包，以及作为响应的报文源IP
* Director转发给RealServer时需要借助隧道，隧道外层的IP头部的源IP是DIP，目标IP是RIP，而RealServer响应给客户端的IP头部是根据隧道内层的IP头分析得到的，源IP是VIP，目标IP是CIP
* 请求报文要经由Director，但响应不经由Director,响应由RealServer自己完成
* 不支持端口映射
* RS的OS须支持隧道功能

**应用场景:**
一般来说，TUN模式常会用来负载调度缓存服务器组，这些缓存服务器一般放置在不同的网络环境，可以就近
折返给客户端。在请求对象不在Cache服务器本地命中的情况下，Cache服务器要向源服务器发送请求，将结
果取回，最后将结果返回给用户。
LAN环境一般多采用DR模式，WAN环境虽然可以用TUN模式，但是一般在WAN环境下，请求转发更多的被
haproxy/nginx/DNS等实现。因此，TUN模式实际应用的很少,跨机房的应用一般专线光纤连接或DNS调度

<img src="../images/lvs-tun01.png">
<img src="../images/lvs-tun02.png">


#### lvs-fullnat：修改请求报文的源和目标IP,默认内核不支持


<img src="../images/lvs-fullnat01.png">