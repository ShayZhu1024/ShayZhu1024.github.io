# 企业级调度器lvs 



## 什么是集群以及集群的分类

Cluster：集群,为解决某个特定问题将多台计算机组合起来形成的单个系统


#### Cluster 分为三种类型：

* LB：Load Balancing，负载均衡，多个主机组成，每个主机只承担一部分访问请求
* HA：High Availiablity，高可用，避免SPOF（single Point Of failure）
  * MTBF:Mean Time Between Failure 平均无故障时间，正常时间
  * MTTR:Mean Time To Restoration（ repair）平均恢复前时间，故障时间
  * A = MTBF /（MTBF+MTTR） (0,1)：99%,99.5%,99.9%,99.99%,99.999%
  * 停机时间又分为两种，一种是计划内停机时间，一种是计划外停机时间

#### [High-performance computing](https://www.top500.org/)



## 分布式和集群的区别


#### 集群
同一个业务系统部署在多台服务器上。集群中每一台服务器实现的功能没有差别，数据和代码都是一样的

#### 分布式

一个业务被拆成多个子业务，或者本身就是不同的业务，部署在多台服务器上。分布式中，每
一台服务器实现的功能是有差别的，数据和代码也是不一样的，分布式每台服务器功能加起来，才是完
整的业务


分布式是以缩短单个任务的执行时间来提升效率的，而集群则是通过提高单位时间内执行的任务数来提
升效率


## LVS

LVS：Linux Virtual Server，负载调度器，内核集成， 阿里的四层SLB(Server Load Balance)是基于LVS+keepalived实现，
LVS 是全球最流行的四层负载均衡开源软件，可以实现LINUX平台下的负载均衡 

[LSV官网](http://www.linuxvirtualserver.org/)



### LVS 工作原理以及查看内核是否支持LVS

VS根据请求报文的目标IP和目标协议及端口将其调度转发至某RS，根据调度算法来挑选RS。LVS是内核
级功能，工作在INPUT链的位置，将发往INPUT的流量进行“处理”


```bash
#查看内核编译配置选项是否支持lvs
egrep -i  ipvs  /boot/config-`uname -r`

#直接查看lvs模块
modinfo ip_vs
```


###  LVS 集群类型中的术语

* VS：Virtual Server，Director Server(DS), Dispatcher(调度器)，Load Balancer
* RS：Real Server(lvs), upstream server(nginx), backend server(haproxy)
* CIP：Client IP
* VIP：Virtual server IP VS外网的IP
* DIP：Director IP VS内网的IP
* RIP：Real server IP 
* 访问流程：CIP <--> VIP == DIP <--> RIP



### LVS 相关程序和命令

#### 程序包

**ipvsadm**

* Unit File: ipvsadm.service
* 主程序：/usr/sbin/ipvsadm
* 规则保存工具：/usr/sbin/ipvsadm-save
* 规则重载工具：/usr/sbin/ipvsadm-restore
* 配置文件：/etc/sysconfig/ipvsadm-config
* ipvs调度规则文件：/etc/sysconfig/ipvsadm

#### Ubuntu系统保存规则和开机加载规则
```bash
#保存规则
    #方法1
    [root@ubuntu2204 ~]#service ipvsadm save
    * Saving IPVS configuration...           [ OK ]
    [root@ubuntu2204 ~]#cat /etc/ipvsadm.rules
    # ipvsadm.rules
    -A -t 192.168.10.100:80 -s wlc
    -a -t 192.168.10.100:80 -r 10.0.0.7:80 -g -w 1
    -a -t 192.168.10.100:80 -r 10.0.0.17:80 -g -w 1
    #方法2
    [root@ubuntu2004 ~]#ipvsadm-save -n > /etc/ipvsadm.rules



#开机自启
[root@ubuntu2004 ~]#vim /etc/default/ipvsadm
AUTO="true"
```


#### 红帽系统保存规则和开机加载规则
```bash
#保存规则
[root@rocky8 ~]#ipvsadm-save -n > /etc/sysconfig/ipvsadm


#开机自启
[root@rocky8 ~]#systemctl enable ipvsadm.service
```

#### ipvsadm 命令


###### 集群服务管理：增、删、改
```bash
ipvsadm -A|E|D -t|u|f service-address [-s scheduler] [-p [timeout]]

-A 添加  -E 修改 -D 删除

-t tcp  集群服务使用tcp端口,TCP协议的端口，VIP:TCP_PORT 如: -t 10.0.0.100:80
-u udp    UDP协议的端口，VIP:UDP_PORT
-f  firewall MARK，标记，一个数字

[-s scheduler]：指定集群的调度算法，默认为wlc

比如：

添加 
ipvsadm -A -t 10.0.0.100:80 -s wrr  #创建一个集群，集群对外ip和监听tcp端口是10.0.0.100 端口80  使用wrr调度算法

删除
ipvsadm -D -t 10.0.0.100:80 -s wrr

修改
ipvsadm -E -t 10.0.0.100:80 -s rr
```


###### 集群服务的RS管理：增、删、改
```bash
ipvsadm -a|e -t|u|f service-address -r server-address [-g|i|m] [-w weight]  


```

###### 查看


###### 从文件加载规则和保存规则到文件