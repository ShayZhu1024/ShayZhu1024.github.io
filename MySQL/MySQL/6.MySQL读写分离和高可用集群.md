# MySQL读写分离和高可用集群

## mycat 

需要注意: 在生产环境中, Mycat 节点最好使用双节点, 即双机热备环境, 防止Mycat这一层出现单点故障

可以使用的高可用集群方式有:

* Keepalived+Mycat+Mysql
* Keepalived+LVS+Mycat+Mysql
* Keepalived+Haproxy+Mycat+Mysql

##### mycat安装和配置

```bash
#!/bin/bash

set -u
set -e

#################注意#####################
#需要在主服务器上创建mycat的连接管理账号
#################注意#####################
#mycat 端口和数据库设置可以在  ./schema.xml 和 ./server.xml 修改


#MASTER=10.0.0.8
#mysql -uroot  -h $MASTER -e "create user root@'10.0.0.%' identified by '123456' "
#mysql -uroot  -h $MASTER -e "grant all on *.* to root@'10.0.0.%'"

MYCAT=Mycat-server-1.6.7.6-release-20210303094759-linux
DIR=/apps/
yum install -y java

[ -e $DIR ] && rm -rf $DIR 
mkdir -p $DIR

tar xf ${MYCAT}.tar.gz  -C $DIR
echo "PATH+=:${DIR}/mycat/bin" > /etc/profile.d/mycat.sh
source /etc/profile.d/mycat.sh

cat > ${DIR}/mycat/conf/server.xml  ./server.xml
cat > ${DIR}/mycat/conf/schema.xml  ./schema.xml
mycat start

```

[具体详见脚本](../Scripts/config_mycat/)



## ProxySQL 实现 MySQL 读写分离


## MHA 主节点高可用

<img src="../../images/mha01.png">


**MHA工作原理**

<img src="../../images/mha002.png">


- MHA利用 SELECT 1 As Value 指令判断 master 服务器的健康性，一旦 master 宕机，MHA 从宕 机崩溃的 master 保存二进制日志事件（binlog events）
- 识别含有最新更新的 slave
- 应用差异的中继日志（relay log）到其他的 slave
- 应用从 master 保存的二进制日志事件（binlog events）到所有 slave 节点
- 提升一个 slave 为新的 master
- 使其他的 slave 连接新的 master 进行复制
- 故障服务器自动被剔除集群(masterha_conf_host)，将配置信息去掉
- 旧的 Master的 VIP 漂移到新的 master上，用户应用就可以访问新的 Master
- MHA 是一次性的高可用性解决方案，Manager 会自动退出

