# MySQL读写分离和高可用集群

## mycat 

需要注意: 在生产环境中, Mycat 节点最好使用双节点, 即双机热备环境, 防止Mycat这一层出现单点故障

可以使用的高可用集群方式有:

* Keepalived+Mycat+Mysql
* Keepalived+LVS+Mycat+Mysql
* Keepalived+Haproxy+Mycat+Mysql

##### mycat安装和配置

```bash
#!/bin/bash

set -u
set -e


#已经配置了主从关系
MASTER=10.0.0.8
SLAVE1=10.0.0.9
SLAVE2=10.0.0.7
PORT=3306 #mycat 开的端口
CAT_USER=root #mycat的root
CAT_PASSWD=123456 #mycat的密码
CAT_DATABASE=hellodb #mycat对外暴露的database
MYSQL_DATABASE=hellodb

MYCAT=Mycat-server-1.6.7.6-release-20210303094759-linux
DIR=/apps/
yum install -y java

[ -e $DIR ] && rm -rf $DIR 
mkdir -p $DIR

tar xf ${MYCAT}.tar.gz  -C $DIR
echo "PATH+=:${DIR}/mycat/bin" > /etc/profile.d/mycat.sh
source /etc/profile.d/mycat.sh

cat > ${DIR}/mycat/conf/server.xml <<EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mycat:server SYSTEM "server.dtd">
<mycat:server xmlns:mycat="http://io.mycat/">
    <system>
        <property name="nonePasswordLogin">0</property> 
        <property name="ignoreUnknownCommand">0</property>
        <property name="useHandshakeV10">1</property>
        <property name="removeGraveAccent">1</property>
        <property name="useSqlStat">0</property>  <!-- 1为开启实时统计、0为关闭 -->
        <property name="useGlobleTableCheck">0</property>  <!-- 1为开启全加班一致性检测、0为关闭 -->
        <property name="sqlExecuteTimeout">300</property>  <!-- SQL 执行超时 单位:秒-->
        <property name="sequenceHandlerType">1</property>
        <property name="sequnceHandlerPattern">(?:(\s*next\s+value\s+for\s*MYCATSEQ_(\w+))(,|\)|\s)*)+</property>
        <property name="subqueryRelationshipCheck">false</property> <!-- 子查询中存在关联查询的情况下,检查关联字段中是否有分片字段 .默认 false -->
        <property name="sequenceHanlderClass">io.mycat.route.sequence.handler.HttpIncrSequenceHandler</property>
        <property name="processorBufferPoolType">0</property>
        <property name="serverPort">${PORT}</property>
        <property name="handleDistributedTransactions">0</property>
        <property name="useOffHeapForMerge">0</property>
        <property name="memoryPageSize">64k</property>
        <property name="spillsFileBufferSize">1k</property>
        <property name="useStreamOutput">0</property>
        <property name="systemReserveMemorySize">384m</property>
        <property name="useZKSwitch">false</property>
        <property name="strictTxIsolation">false</property>
        <property name="parallExecute">0</property>
        <property name="serverBacklog">2048</property>
    </system>
    <user name="${CAT_USER}" defaultAccount="true">
        <property name="password">${CAT_PASSWD}</property>
        <property name="schemas">${CAT_DATABASE}</property>
        <property name="defaultSchema">${CAT_DATABASE}</property>
    </user>
</mycat:server>
EOF

#修改schema 实现读写分离
cat > ${DIR}/mycat/conf/schema.xml <<EOF
<?xml version="1.0"?>                         
<!DOCTYPE mycat:schema SYSTEM "schema.dtd">
<mycat:schema xmlns:mycat="http://io.mycat/">
    <schema name="${CAT_DATABASE}" checkSQLschema="false" sqlMaxLimit="100" dataNode="dn1"></schema>                                 
    <dataNode name="dn1" dataHost="localhost1" database="${MYSQL_DATABASE}" />
    <dataHost name="localhost1" maxCon="1000" minCon="10" balance="1" writeType="0" dbType="mysql" dbDriver="native" switchType="1" slaveThreshold="100">
        <heartbeat>select user()</heartbeat>
        <writeHost host="host1" url="${MASTER}:3306" user="root" password="123456">
            <readHost host="host2" url="${SLAVE1}:3306" user="root" password="123456" />
            <readHost host="host3" url="${SLAVE2}:3306" user="root" password="123456" />
        </writeHost>                          
    </dataHost>                               
</mycat:schema>
EOF

mycat start

```