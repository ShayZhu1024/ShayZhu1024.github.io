# PostgreSQL安装和基本使用

## 安装

#### yum或者apt 安装

###### redhat系安装
[postgresql-yum-rocky8](https://www.postgresql.org/download/linux/redhat/)

```bash
sudo dnf install -y https://download.postgresql.org/pub/repos/yum/reporpms/EL-8-x86_64/pgdg-redhat-repo-latest.noarch.rpm
sudo dnf -qy module disable postgresql
sudo dnf install -y postgresql16-server
sudo /usr/pgsql-16/bin/postgresql-16-setup initdb
sudo systemctl enable postgresql-16
sudo systemctl start postgresql-16
```

###### ubuntu 安装
[postgresql-apt-ubuntu20](https://www.postgresql.org/download/linux/ubuntu/)

```bash
sudo apt install curl ca-certificates
sudo install -d /usr/share/postgresql-common/pgdg
sudo curl -o /usr/share/postgresql-common/pgdg/apt.postgresql.org.asc --fail https://www.postgresql.org/media/keys/ACCC4CF8.asc
sudo sh -c 'echo "deb [signed-by=/usr/share/postgresql-common/pgdg/apt.postgresql.org.asc] https://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
sudo apt update
sudo apt -y install postgresql
```



#### 源码编译安装

1. 下载源码 https://www.postgresql.org/ftp/source/
2. 安装依赖:`yum install make readline-devel zlib-devel gcc libicu-devel -y `
3. ./configure  --prefix=/apps/pgsql  --with-pgport=5432
4. make -j 2 world
5. groupadd -r  postgres
6. useradd -r -s /bin/bash  -m  -g postgres -d  /data/postgres postgres
7. echo "postgres:123456" | chpasswd
8. make install-world

##### 后续步骤

###### 系统初始化和优化配置
```bash
vim /etc/sysctl.conf
sysctl -p

kernel.shmmax = 68719476736
kernel.shmall = 4294967296
kernel.shmmni = 4096
kernel.sem = 50100 64128000 50100 1280
fs.file-max = 7672460
net.ipv4.ip_local_port_range = 9000 65000
net.core.rmem_default = 1048576
net.core.rmem_max = 4194304
net.core.wmem_max = 1048576
net.core.wmem_default = 262144  


vim /etc/systemd/system.conf
# 设置系统最大打开文件数量
DefaultLimitNOFILE=1000000
# 设置系统最大进程数量   
DefaultLimitNPROC=1000000
# 设置系统最大锁内存量（单位为KB）
DefaultLimitMEMLOCK=60000                                                                                                                                                                   
# 设置系统最大消息队列大小（单位为字节）
DefaultLimitMSGQUEUE=8192000
# 设置系统对核心转储文件大小的限制（unlimited表示无限制）
DefaultLimitCORE=infinity
```

###### 创建数据目录并授权

```bash
mkdir -p /data/postgres/16/data
chown -R postgres:postgres /data/postgres/16/data
```

###### 设置环境变量
```bash
vim /etc/profile.d/pgsql.sh

export PGHOME=/apps/pgsql  
export PATH+=:$PGHOME/bin/
export PGDATA=/data/postgres/16/data 
export PGUSER=postgres  
export MANPATH+=:/apps/pgsql/share/man
```






